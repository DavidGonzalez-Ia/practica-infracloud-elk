apiVersion: v1
kind: ConfigMap
metadata:
  name: elk-dashboards
  namespace: cloudedu
data:
  kibana-saved-objects.ndjson: |
    {"type":"index-pattern","id":"logs-*","attributes":{"title":"logs-*","timeFieldName":"@timestamp","fields":"[{\"name\":\"@timestamp\",\"type\":\"date\"},{\"name\":\"message\",\"type\":\"string\"},{\"name\":\"level\",\"type\":\"string\"},{\"name\":\"logger\",\"type\":\"string\"},{\"name\":\"application\",\"type\":\"string\"}]"}}
    {"type":"dashboard","id":"taskmanager-overview","attributes":{"title":"TaskManager Overview","panels":[{"visualization":"logs-by-level","x":0,"y":0,"w":6,"h":3},{"visualization":"logs-over-time","x":6,"y":0,"w":6,"h":3},{"visualization":"requests-per-endpoint","x":0,"y":3,"w":6,"h":3},{"visualization":"db-connections","x":6,"y":3,"w":6,"h":3}]}}
    {"type":"visualization","id":"logs-by-level","attributes":{"title":"Logs by Level","visState":"{\"title\":\"Logs by Level\",\"type\":\"pie\",\"params\":{\"addTooltip\":true},\"aggs\":[{\"id\":\"1\",\"enabled\":true,\"type\":\"count\",\"schema\":\"metric\",\"params\":{}},{\"id\":\"2\",\"enabled\":true,\"type\":\"terms\",\"schema\":\"segment\",\"params\":{\"field\":\"level.keyword\",\"size\":10}}]}"}}

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: elasticsearch-templates
  namespace: cloudedu
data:
  index-template.json: |
    {
      "index_patterns": ["logs-*", "filebeat-*"],
      "template": {
        "settings": {
          "number_of_shards": 1,
          "number_of_replicas": 0,
          "index.lifecycle.name": "logs-policy",
          "index.lifecycle.rollover_alias": "logs",
          "analysis": {
            "analyzer": {
              "default": {
                "type": "standard",
                "stopwords": "_english_"
              }
            }
          }
        },
        "mappings": {
          "properties": {
            "@timestamp": {
              "type": "date"
            },
            "message": {
              "type": "text",
              "fields": {
                "keyword": {
                  "type": "keyword"
                }
              }
            },
            "level": {
              "type": "keyword"
            },
            "logger": {
              "type": "keyword"
            },
            "application": {
              "type": "keyword"
            },
            "pod": {
              "type": "keyword"
            },
            "namespace": {
              "type": "keyword"
            },
            "hostname": {
              "type": "keyword"
            },
            "task_id": {
              "type": "keyword"
            },
            "title": {
              "type": "text"
            },
            "error": {
              "type": "text"
            },
            "error_code": {
              "type": "keyword"
            },
            "attempt": {
              "type": "integer"
            },
            "count": {
              "type": "integer"
            }
          }
        }
      }
    }

---
apiVersion: batch/v1
kind: Job
metadata:
  name: elk-setup-job
  namespace: cloudedu
spec:
  template:
    spec:
      containers:
      - name: setup
        image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
        command:
        - /bin/bash
        - -c
        - |
          # Esperar a que Elasticsearch esté listo
          until curl -s http://elasticsearch:9200/_cluster/health; do
            echo "Esperando a Elasticsearch..."
            sleep 5
          done
          
          echo "Elasticsearch está listo"
          
          # Crear indice inicial
          curl -X PUT "http://elasticsearch:9200/logs-initial" \
            -H 'Content-Type: application/json' \
            -d '{"settings":{"number_of_shards":1,"number_of_replicas":0}}'
          
          echo "Índice inicial creado"
      restartPolicy: Never
  backoffLimit: 4
